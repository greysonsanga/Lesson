<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Powered KoboToolbox Form Filler</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-6 text-center">KoboToolbox Form Auto-Filler</h1>
    <div class="space-y-4">
      <button onclick="openForm()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Open and Auto-Fill Form</button>
      <button onclick="submitForm()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500" id="submitBtn" disabled>Submit Form</button>
      <p id="message" class="text-sm text-gray-600 text-center"></p>
      <iframe id="formIframe" class="w-full h-96 mt-4 hidden" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <script>
    const FORM_URL = "https://ee.kobotoolbox.org/x/so7jKAYr";
    const message = document.getElementById("message");
    const iframe = document.getElementById("formIframe");
    const submitBtn = document.getElementById("submitBtn");

    // Mock data for AI auto-filling
    const mockData = {
      fullName: ["Amina Juma", "John Mushi", "Fatuma Ally", "Emmanuel Kweka"],
      gender: ["Male", "Female"],
      civilStatus: ["Single", "Married", "Divorced"],
      placeOfBirth: ["Dar es Salaam", "Dodoma", "Arusha"],
      province: ["Dar es Salaam", "Mwanza", "Mbeya"],
      address: ["123 Mbagala St", "45 Kivukoni Rd", "78 Uhuru Ave"],
      idNumber: ["TZ123456789", "TZ987654321", "TZ456789123"],
      idType: ["Tazkira", "Passport"],
      email: ["amina.juma@example.com", "john.mushi@example.com"],
      phone: ["+255712345678", "+255723456789"]
    };

    function getRandomItem(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    // AI logic to auto-fill form
    function autoFillForm(doc) {
      try {
        // Find all form inputs
        const textInputs = doc.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
        const radioInputs = doc.querySelectorAll('input[type="radio"]');
        const checkboxes = doc.querySelectorAll('input[type="checkbox"]');
        const selects = doc.querySelectorAll('select');

        // Auto-fill text inputs
        textInputs.forEach(input => {
          const name = input.name.toLowerCase();
          if (name.includes("name")) input.value = getRandomItem(mockData.fullName);
          else if (name.includes("birth")) input.value = getRandomItem(mockData.placeOfBirth);
          else if (name.includes("address")) input.value = getRandomItem(mockData.address);
          else if (name.includes("id") || name.includes("tazkira") || name.includes("passport")) input.value = getRandomItem(mockData.idNumber);
          else if (name.includes("email")) input.value = getRandomItem(mockData.email);
          else if (name.includes("phone")) input.value = getRandomItem(mockData.phone);
          else input.value = "Sample Text";
        });

        // Auto-fill radio buttons (select one per group)
        const radioGroups = new Set([...radioInputs].map(r => r.name));
        radioGroups.forEach(group => {
          const groupRadios = doc.querySelectorAll(`input[name="${group}"]`);
          const randomRadio = groupRadios[Math.floor(Math.random() * groupRadios.length)];
          randomRadio.checked = true;
        });

        // Auto-fill checkboxes (randomly check 0-2 per group)
        const checkboxGroups = new Set([...checkboxes].map(c => c.name));
        checkboxGroups.forEach(group => {
          const groupCheckboxes = doc.querySelectorAll(`input[name="${group}"]`);
          const toCheck = Math.floor(Math.random() * 3); // 0-2 checkboxes
          for (let i = 0; i < toCheck && i < groupCheckboxes.length; i++) {
            groupCheckboxes[i].checked = true;
          }
        });

        // Auto-fill select dropdowns
        selects.forEach(select => {
          const options = select.querySelectorAll('option:not([value=""])');
          if (options.length > 0) {
            const randomOption = options[Math.floor(Math.random() * options.length)];
            select.value = randomOption.value;
          }
        });

        message.textContent = "Form auto-filled successfully! Click 'Submit Form' to submit.";
        submitBtn.disabled = false;
      } catch (error) {
        message.textContent = "Error auto-filling form. Try the content script fallback (see console).";
        console.error(error);
        console.log(getContentScript());
      }
    }

    // Open form and attempt auto-fill
    function openForm() {
      message.textContent = "Opening form...";
      iframe.classList.remove("hidden");
      iframe.src = FORM_URL;

      iframe.onload = () => {
        try {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          if (doc) {
            autoFillForm(doc);
          } else {
            throw new Error("Cannot access iframe document.");
          }
        } catch (error) {
          message.textContent = "Cross-origin restriction detected. Use content script (see console).";
          console.error(error);
          console.log(getContentScript());
          // Fallback: Open in new tab
          window.open(FORM_URL, "_blank");
        }
      };
    }

    // Submit form programmatically
    function submitForm() {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const submitButton = doc.querySelector('.form-footer__button--submit, button[type="submit"], input[type="submit"]');
        if (submitButton) {
          submitButton.click();
          message.textContent = "Form submitted successfully!";
          submitBtn.disabled = true;
        } else {
          message.textContent = "Submit button not found. Check form manually.";
        }
      } catch (error) {
        message.textContent = "Error submitting form. Submit manually in the form tab.";
        console.error(error);
      }
    }

    // Generate content script for manual execution
    function getContentScript() {
      return `
        // Paste this in the browser console on the form page (https://ee.kobotoolbox.org/x/so7jKAYr)
        const mockData = ${JSON.stringify(mockData)};
        function getRandomItem(array) {
          return array[Math.floor(Math.random() * array.length)];
        }
        const textInputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
        textInputs.forEach(input => {
          const name = input.name.toLowerCase();
          if (name.includes("name")) input.value = getRandomItem(mockData.fullName);
          else if (name.includes("birth")) input.value = getRandomItem(mockData.placeOfBirth);
          else if (name.includes("address")) input.value = getRandomItem(mockData.address);
          else if (name.includes("id") || name.includes("tazkira") || name.includes("passport")) input.value = getRandomItem(mockData.idNumber);
          else if (name.includes("email")) input.value = getRandomItem(mockData.email);
          else if (name.includes("phone")) input.value = getRandomItem(mockData.phone);
          else input.value = "Sample Text";
        });
        const radioInputs = document.querySelectorAll('input[type="radio"]');
        const radioGroups = new Set([...radioInputs].map(r => r.name));
        radioGroups.forEach(group => {
          const groupRadios = document.querySelectorAll(\`input[name="\${group}"]\`);
          const randomRadio = groupRadios[Math.floor(Math.random() * groupRadios.length)];
          randomRadio.checked = true;
        });
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const checkboxGroups = new Set([...checkboxes].map(c => c.name));
        checkboxGroups.forEach(group => {
          const groupCheckboxes = document.querySelectorAll(\`input[name="\${group}"]\`);
          const toCheck = Math.floor(Math.random() * 3);
          for (let i = 0; i < toCheck && i < groupCheckboxes.length; i++) {
            groupCheckboxes[i].checked = true;
          }
        });
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
          const options = select.querySelectorAll('option:not([value=""])');
          if (options.length > 0) {
            const randomOption = options[Math.floor(Math.random() * options.length)];
            select.value = randomOption.value;
          }
        });
        console.log("Form auto-filled. Click the submit button manually.");
      `;
    }
  </script>
</body>
</html>
